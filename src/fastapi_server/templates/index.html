<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CXI MCP Server Interface</title>
    <style>
        :root {
            --color-canvas-default: #fff;
            --color-canvas-subtle: #f6f8fa;
            --color-border-default: #d0d7de;
            --color-border-muted: #d8dee4;
            --color-accent-fg: #0969da;
            --color-accent-emphasis: #0969da;
            --color-fg-default: #24292f;
            --color-fg-muted: #57606a;
            --color-fg-subtle: #6e7781;
            --color-success-fg: #1a7f37;
            --color-danger-fg: #cf222e;
        }
        
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            color: var(--color-fg-default);
            line-height: 1.6;
        }
        
        .container {
            display: flex;
            height: 100vh;
            width: 100%;
            padding: 0;
            margin: 0;
        }
        
        .main-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--color-border-default);
            max-width: 65%;
        }
        
        .sidebar-panel {
            width: 35%;
            padding: 16px;
            overflow-y: auto;
            background-color: var(--color-canvas-subtle);
        }
        
        header {
            border-bottom: 1px solid var(--color-border-muted);
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        h1 {
            font-size: 20px;
            font-weight: 500;
            margin: 0;
        }
        
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .chat-header {
            background-color: var(--color-canvas-subtle);
            border-bottom: 1px solid var(--color-border-default);
            padding: 8px 16px;
        }
        
        .chat-header h2 {
            font-size: 16px;
            font-weight: 500;
            margin: 0;
        }
        
        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background-color: var(--color-canvas-default);
        }
        
        .chat-form {
            background-color: var(--color-canvas-subtle);
            padding: 16px;
            border-top: 1px solid var(--color-border-default);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .form-group {
            display: flex;
            gap: 8px;
        }
        
        .chat-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--color-border-default);
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
            line-height: 20px;
        }
        
        .file-input-container {
            position: relative;
            display: inline-block;
        }
        
        .file-input {
            position: absolute;
            top: 0;
            left: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-label {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 5px 12px;
            font-size: 14px;
            font-weight: 500;
            line-height: 20px;
            white-space: nowrap;
            vertical-align: middle;
            cursor: pointer;
            border: 1px solid var(--color-border-default);
            border-radius: 6px;
            background-color: var(--color-canvas-default);
            color: var(--color-fg-default);
        }
        
        .file-label:hover {
            background-color: var(--color-canvas-subtle);
        }
        
        .file-name {
            margin-left: 8px;
            font-size: 12px;
            color: var(--color-fg-muted);
        }
        
        .button {
            padding: 5px 16px;
            font-size: 14px;
            font-weight: 500;
            line-height: 20px;
            white-space: nowrap;
            vertical-align: middle;
            cursor: pointer;
            border: 1px solid var(--color-border-default);
            border-radius: 6px;
            background-color: var(--color-canvas-default);
            color: var(--color-fg-default);
        }
        
        .button.primary {
            background-color: var(--color-accent-emphasis);
            border-color: var(--color-accent-emphasis);
            color: white;
        }
        
        .button:hover {
            background-color: var(--color-canvas-subtle);
        }
        
        .button.primary:hover {
            background-color: #0550ae;
        }
        
        .message {
            margin-bottom: 16px;
            padding: 16px;
            border-radius: 6px;
            border: 1px solid var(--color-border-default);
        }
        
        .user-message {
            background-color: var(--color-canvas-subtle);
        }
        
        .ai-message {
            background-color: var(--color-canvas-default);
            border-left: 4px solid var(--color-accent-emphasis);
        }
        
        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .message-author {
            font-weight: 600;
            margin-right: 8px;
        }
        
        .message-time {
            font-size: 12px;
            color: var(--color-fg-muted);
        }
        
        .message-content {
            margin-bottom: 8px;
        }
        
        .message-metadata {
            font-size: 12px;
            padding: 8px;
            margin-top: 8px;
            border-radius: 6px;
            background-color: var(--color-canvas-subtle);
            color: var(--color-fg-muted);
            font-family: SFMono-Regular, Consolas, Liberation Mono, Menlo, monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        
        details {
            margin-top: 8px;
        }
        
        summary {
            cursor: pointer;
            color: var(--color-fg-muted);
            font-size: 12px;
        }
        
        .image-container {
            max-width: 100%;
            margin: 8px 0;
        }
        
        .image-container img {
            max-width: 100%;
            border: 1px solid var(--color-border-default);
            border-radius: 6px;
        }
        
        .debug-tools {
            padding: 16px;
            background-color: var(--color-canvas-subtle);
            border: 1px solid var(--color-border-default);
            border-radius: 6px;
            margin-bottom: 16px;
        }
        
        .debug-tools h2 {
            font-size: 16px;
            font-weight: 500;
            margin-top: 0;
        }
        
        .tool-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .tool-result {
            font-family: SFMono-Regular, Consolas, Liberation Mono, Menlo, monospace;
            background-color: var(--color-canvas-default);
            padding: 12px;
            border: 1px solid var(--color-border-default);
            border-radius: 6px;
            white-space: pre-wrap;
            overflow-x: auto;
            font-size: 13px;
            line-height: 1.4;
            margin-bottom: 16px;
            max-height: 200px;
            overflow-y: auto;
        }

        .frame-params-form {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 8px;
        }
        
        .frame-params-form .form-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .frame-params-form label {
            font-size: 14px;
        }
        
        .frame-params-form input {
            padding: 6px 8px;
            border: 1px solid var(--color-border-default);
            border-radius: 6px;
        }
        
        .frame-params-form button {
            grid-column: span 2;
            margin-top: 8px;
        }
        
        .image-gallery {
            margin-top: 16px;
            border-top: 1px solid var(--color-border-muted);
            padding-top: 16px;
        }
        
        .image-gallery h3 {
            font-size: 14px;
            font-weight: 500;
            margin-top: 0;
            margin-bottom: 8px;
        }
        
        .gallery-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }
        
        .gallery-image {
            width: calc(50% - 4px);
            border: 1px solid var(--color-border-default);
            border-radius: 6px;
            overflow: hidden;
        }
        
        .gallery-image img {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .tool-call, .tool-response {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        
        .tool-call {
            background-color: rgba(9, 105, 218, 0.08);
            border-left: 3px solid var(--color-accent-fg);
        }
        
        .tool-response {
            background-color: rgba(26, 127, 55, 0.08);
            border-left: 3px solid var(--color-success-fg);
        }
        
        .tool-call-label, .tool-response-label {
            font-weight: 600;
            font-size: 12px;
            margin-bottom: 5px;
        }
        
        .tool-call-content, .tool-response-content {
            font-family: SFMono-Regular, Consolas, Liberation Mono, Menlo, monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        
        .tool-call-item {
            margin-bottom: 5px;
        }
        
        .error-message {
            color: var(--color-danger-fg);
            padding: 10px;
            border: 1px solid var(--color-danger-fg);
            border-radius: 6px;
            margin-top: 10px;
            background-color: rgba(207, 34, 46, 0.1);
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: var(--color-accent-fg);
            animation: spin 0.8s ease infinite;
            margin-right: 10px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .conversation-workflow {
            margin: 16px 0;
            border-top: 1px solid var(--color-border-muted);
            padding-top: 16px;
        }
        
        .conversation-workflow h3 {
            font-size: 14px;
            font-weight: 600;
            margin: 0 0 10px 0;
            color: var(--color-fg-muted);
        }
        
        .tool-workflow-item {
            margin-bottom: 16px;
            border-left: 2px solid var(--color-border-muted);
            padding-left: 10px;
        }
        
        .tool-call, .tool-response {
            margin: 8px 0;
            padding: 8px 10px;
            border-radius: 6px;
        }
        
        .tool-call {
            background-color: rgba(9, 105, 218, 0.08);
        }
        
        .tool-response {
            background-color: rgba(26, 127, 55, 0.08);
            margin-left: 16px;
        }
        
        .tool-call-label, .tool-response-label {
            font-weight: 600;
            font-size: 12px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
        }
        
        .tool-icon {
            margin-right: 5px;
        }
        
        .tool-call-content, .tool-response-content {
            font-family: SFMono-Regular, Consolas, Liberation Mono, Menlo, monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        
        .tool-call-content pre {
            margin: 0;
            background-color: rgba(255, 255, 255, 0.5);
            padding: 8px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-panel">
            <header>
                <h1>CXI MCP Server Interface</h1>
            </header>
            
            <div class="chat-container">
                <div class="chat-header">
                    <h2>Chat</h2>
                </div>
                <div class="chat-history" id="chat-history"></div>
                <form id="chat-form" class="chat-form">
                    <div class="file-input-container">
                        <label class="file-label">
                            <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16">
                                <path d="M2 1.75C2 .784 2.784 0 3.75 0h6.586c.464 0 .909.184 1.237.513l2.914 2.914c.329.328.513.773.513 1.237v9.586A1.75 1.75 0 0 1 13.25 16h-9.5A1.75 1.75 0 0 1 2 14.25Zm1.75-.25a.25.25 0 0 0-.25.25v12.5c0 .138.112.25.25.25h9.5a.25.25 0 0 0 .25-.25V6h-2.75A1.75 1.75 0 0 1 9 4.25V1.5Zm6.75.062V4.25c0 .138.112.25.25.25h2.688l-.011-.013-2.914-2.914-.013-.011Z"></path>
                            </svg>
                            Attach Image
                            <input type="file" id="image-upload" class="file-input" accept="image/*">
                        </label>
                        <span id="file-name" class="file-name"></span>
                    </div>
                    <div class="form-group">
                        <input type="text" id="chat-message" class="chat-input" placeholder="Type your message..." required>
                        <button type="submit" id="send-button" class="button primary">Send</button>
                    </div>
                </form>
                
                <div class="image-gallery" id="image-gallery" style="display: none;">
                    <h3>Images from Conversation</h3>
                    <div class="gallery-container" id="gallery-container"></div>
                </div>
            </div>
        </div>
        
        <div class="sidebar-panel">
            <div class="debug-tools">
                <h2>Debug Tools</h2>
                <div class="tool-buttons">
                    <button id="get-selection" class="button">Get Selection</button>
                    <button id="create-frame" class="button">Create Root Frame</button>
                    <button id="create-text" class="button">Create Text in Root Frame</button>
                </div>
                
                <div id="frame-params" style="display: none;">
                    <h3>Create Frame Parameters</h3>
                    <form id="frame-params-form" class="frame-params-form">
                        <div class="form-group">
                            <label for="frame-x">X:</label>
                            <input type="number" id="frame-x" value="0">
                        </div>
                        <div class="form-group">
                            <label for="frame-y">Y:</label>
                            <input type="number" id="frame-y" value="0">
                        </div>
                        <div class="form-group">
                            <label for="frame-width">Width:</label>
                            <input type="number" id="frame-width" value="320" required>
                        </div>
                        <div class="form-group">
                            <label for="frame-height">Height:</label>
                            <input type="number" id="frame-height" value="720" required>
                        </div>
                        <div class="form-group">
                            <label for="frame-name">Name:</label>
                            <input type="text" id="frame-name" value="Frame">
                        </div>
                        <button type="submit" class="button primary">Create</button>
                    </form>
                </div>
                
                <div id="tool-results" class="tool-result"></div>
            </div>
        </div>
    </div>

    <script>
        // File input handling
        document.getElementById('image-upload').addEventListener('change', function(e) {
            const fileName = e.target.files.length > 0 ? e.target.files[0].name : '';
            document.getElementById('file-name').textContent = fileName;
        });
        
        // Format date to readable string
        function formatDate(date) {
            return new Date(date).toLocaleTimeString();
        }
        
        // Set up logging for debugging
        const debugMode = true;
        function log(message, data) {
            if (debugMode) {
                console.log(`[DEBUG] ${message}`, data || '');
            }
        }
        
        // Helper function to safely extract AI message content
        function extractAIContent(response) {
            log("Extracting content from:", response);
            
            try {
                // First check if it's a direct "response" object with "response" key
                if (response && response.response) {
                    log("Found response key:", response.response);
                    
                    // Check if it's a string that needs parsing
                    if (typeof response.response === 'string') {
                        try {
                            const parsed = JSON.parse(response.response);
                            if (parsed && parsed.messages) {
                                log("Parsed string response into messages:", parsed);
                                return processMessages(parsed);
                            }
                        } catch (e) {
                            // Not JSON, treat as plain string content
                            log("Response is a plain string:", response.response);
                            return {
                                content: response.response,
                                fullResponse: response,
                                images: [],
                                messages: []
                            };
                        }
                    }
                }
                
                // Next check for json_response key (newer format)
                if (response && response.json_response) {
                    log("Found json_response key:", response.json_response);
                    
                    // Use the main_content if available
                    if (response.json_response.main_content) {
                        log("Found main_content:", response.json_response.main_content);
                        return {
                            content: response.json_response.main_content,
                            fullResponse: response.json_response,
                            images: response.json_response.images || [],
                            messages: response.json_response.messages || []
                        };
                    }
                    
                    // Check for messages array
                    if (response.json_response.messages && response.json_response.messages.length > 0) {
                        log("Found messages array in json_response");
                        return processMessages(response.json_response);
                    }
                }
                
                // Direct check for messages array at top level
                if (response && response.messages && Array.isArray(response.messages)) {
                    log("Found top-level messages array");
                    return processMessages(response);
                }
                
                // If it's a plain string, return it directly
                if (typeof response === 'string') {
                    log("Response is a plain string");
                    return {
                        content: response,
                        fullResponse: { raw: response },
                        images: [],
                        messages: []
                    };
                }
                
                // Fallback: just stringify the entire response
                log("No recognized format, using fallback");
                return {
                    content: JSON.stringify(response),
                    fullResponse: response,
                    images: [],
                    messages: []
                };
                
            } catch (e) {
                console.error("Error extracting AI content:", e);
                return {
                    content: `Error processing response: ${e.message}`,
                    fullResponse: response || {},
                    images: [],
                    messages: []
                };
            }
            
            // Helper function to process message arrays
            function processMessages(container) {
                const messages = container.messages || [];
                
                // Find last assistant message with content
                for (let i = messages.length - 1; i >= 0; i--) {
                    const msg = messages[i];
                    
                    // Check for new format where content is in data.content
                    if (msg.role === 'assistant' && msg.content?.data?.content) {
                        return {
                            content: msg.content.data.content,
                            fullResponse: container,
                            images: container.images || [],
                            messages: messages
                        };
                    }
                    
                    // Check for older format where content is direct
                    if ((msg.type === 'ai' || msg.id?.startsWith('run-')) && msg.content) {
                        return {
                            content: msg.content,
                            fullResponse: container,
                            images: container.images || [],
                            messages: messages
                        };
                    }
                }
                
                // No suitable message found
                return {
                    content: "",
                    fullResponse: container,
                    images: container.images || [],
                    messages: messages
                };
            }
        }
                
        // Format response message with proper styling
        function formatResponseMessage(response) {
            log("Formatting response:", response);
            
            if (!response) {
                return '<div class="error-message">Empty response received</div>';
            }
            
            // First check if we have json_response structure
            if (response.json_response) {
                const json_response = response.json_response;
                const messages = json_response.messages || [];
                
                // Find the final assistant message (the one with actual content)
                let finalMessage = "";
                let conversationFlow = "";
                let toolCalls = [];
                let toolResponses = [];
                
                // First pass - collect all tool calls and responses
                messages.forEach(msg => {
                    // Only process assistant and tool messages (skip user)
                    if (msg.role === 'assistant') {
                        const content = msg.content?.data?.content || '';
                        
                        // Check for tool calls
                        if (msg.content?.data?.tool_calls && msg.content.data.tool_calls.length > 0) {
                            msg.content.data.tool_calls.forEach(tool => {
                                toolCalls.push({
                                    id: tool.id,
                                    name: tool.name,
                                    args: tool.args
                                });
                            });
                        }
                        
                        // If this is a content message (not just tool calls), save it as potential final message
                        if (content && content.trim() !== '') {
                            finalMessage = content;
                        }
                    }
                    
                    if (msg.role === 'tool') {
                        const toolContent = msg.content?.data?.content || '';
                        const toolName = msg.content?.data?.name || '';
                        const toolCallId = msg.content?.data?.tool_call_id || '';
                        
                        if (toolContent && toolName) {
                            toolResponses.push({
                                id: toolCallId,
                                name: toolName,
                                content: toolContent
                            });
                        }
                    }
                });
                
                // Now build the conversation flow visualization
                // Group related tool calls with their responses
                if (toolCalls.length > 0) {
                    // Only show tool workflow if we have tool calls
                    conversationFlow += '<div class="conversation-workflow">';
                    conversationFlow += '<h3>Actions Performed</h3>';
                    
                    toolCalls.forEach(tool => {
                        // Create a container for each tool call and its response
                        conversationFlow += `
                            <div class="tool-workflow-item">
                                <div class="tool-call">
                                    <div class="tool-call-label">
                                        <span class="tool-icon">⚙️</span>
                                        <strong>${tool.name}</strong>
                                    </div>
                                    <div class="tool-call-content">
                                        <pre>${JSON.stringify(tool.args, null, 2)}</pre>
                                    </div>
                                </div>
                        `;
                        
                        // Find matching tool response
                        const response = toolResponses.find(r => r.id === tool.id);
                        if (response) {
                            conversationFlow += `
                                <div class="tool-response">
                                    <div class="tool-response-label">
                                        <span class="tool-icon">✓</span>
                                        <strong>${response.name} Result:</strong>
                                    </div>
                                    <div class="tool-response-content">${response.content}</div>
                                </div>
                            `;
                        }
                        
                        conversationFlow += '</div>'; // Close workflow-item
                    });
                    
                    conversationFlow += '</div>'; // Close conversation-workflow
                }
                
                // For the main display, only show the final message content
                if (finalMessage) {
                    return `
                        <div class="message-content">${finalMessage}</div>
                        ${conversationFlow}
                        <details>
                            <summary>Show details</summary>
                            <div class="message-metadata">${JSON.stringify(response, null, 2)}</div>
                        </details>
                    `;
                } else {
                    // If no final message was found but we have a workflow
                    return `
                        ${conversationFlow}
                        <details>
                            <summary>Show details</summary>
                            <div class="message-metadata">${JSON.stringify(response, null, 2)}</div>
                        </details>
                    `;
                }
            }
            
            // If response is not in the expected format, fall back to previous implementation
            try {
                const { content, fullResponse } = extractAIContent(response);
                
                return `
                    <div class="message-content">${content || "No message content"}</div>
                    <details>
                        <summary>Show details</summary>
                        <div class="message-metadata">${JSON.stringify(fullResponse, null, 2)}</div>
                    </details>
                `;
            } catch (e) {
                console.error("Error formatting message:", e);
                return `
                    <div class="error-message">Error formatting response: ${e.message}</div>
                    <details>
                        <summary>Show raw response</summary>
                        <div class="message-metadata">${JSON.stringify(response, null, 2)}</div>
                    </details>
                `;
            }
        }

        // Add image to gallery
        function addImageToGallery(imageData) {
            if (!imageData) return;
            
            const galleryContainer = document.getElementById('gallery-container');
            const imageGallery = document.getElementById('image-gallery');
            
            // Show the gallery if it was hidden
            imageGallery.style.display = 'block';
            
            // Create and add the image
            const imageWrapper = document.createElement('div');
            imageWrapper.className = 'gallery-image';
            
            const img = document.createElement('img');
            img.src = `data:image/png;base64,${imageData}`;
            img.alt = 'Generated image';
            
            imageWrapper.appendChild(img);
            galleryContainer.appendChild(imageWrapper);
        }

        // Add message to chat history
        function addMessageToHistory(author, content, isUser = false) {
            log(`Adding message from ${author}`, content);
            
            const history = document.getElementById('chat-history');
            const messageElement = document.createElement('div');
            messageElement.className = `message ${isUser ? 'user-message' : 'ai-message'}`;
            
            const now = new Date();
            
            // For user messages, just show the text
            let messageContentHTML;
            if (isUser) {
                messageContentHTML = `<div class="message-content">${content}</div>`;
            } else {
                // For AI messages, use the formatter
                messageContentHTML = formatResponseMessage(content);
            }
            
            const messageHTML = `
                <div class="message-header">
                    <span class="message-author">${author}</span>
                    <span class="message-time">${formatDate(now)}</span>
                </div>
                <div class="message-content-container">
                    ${messageContentHTML}
                </div>
            `;
            
            messageElement.innerHTML = messageHTML;
            history.appendChild(messageElement);
            history.scrollTop = history.scrollHeight;
            
            // If it's an AI response, check for images and add to gallery
            if (!isUser) {
                const { images } = extractAIContent(content);
                if (images && images.length > 0) {
                    images.forEach(img => {
                        if (img && img.data && !img.data.startsWith('base64_uris')) {
                            addImageToGallery(img.data);
                        }
                    });
                }
            }
        }

        // Show loading indicator
        function showLoading(button) {
            button.disabled = true;
            button.innerHTML = '<span class="loading"></span>Sending...';
        }

        // Reset button
        function resetButton(button, text = 'Send') {
            button.disabled = false;
            button.textContent = text;
        }

        // Chat form submission
        document.getElementById('chat-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = document.getElementById('chat-message').value;
            const imageFile = document.getElementById('image-upload').files[0];
            
            if (!message) return;
            
            // Add user message to chat
            addMessageToHistory('You', message, true);
            
            // Clear inputs
            document.getElementById('chat-message').value = '';
            document.getElementById('file-name').textContent = '';
            document.getElementById('image-upload').value = '';
            
            // Show loading state
            const sendButton = document.getElementById('send-button');
            showLoading(sendButton);
            
            try {
                let response;
                
                if (imageFile) {
                    log("Sending message with image", { message, image: imageFile.name });
                    // Send to /chat-img endpoint with image
                    const formData = new FormData();
                    formData.append('message', message);
                    formData.append('image', imageFile);
                    
                    response = await fetch('/chat-img', {
                        method: 'POST',
                        body: formData,
                    });
                } else {
                    log("Sending text-only message", { message });
                    // Send to /chat endpoint (text only)
                    response = await fetch('/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ message }),
                    });
                }
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                log("Server response:", data);
                addMessageToHistory('AI', data);
            } catch (error) {
                console.error("Request error:", error);
                addMessageToHistory('AI', `Error: ${error.message}`);
            } finally {
                resetButton(sendButton);
            }
        });
        
        // Get Selection Tool
        document.getElementById('get-selection').addEventListener('click', async (e) => {
            const button = e.target;
            showLoading(button);
            
            try {
                const response = await fetch('/tool/get_selection', {
                    method: 'POST',
                });
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                document.getElementById('tool-results').textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                document.getElementById('tool-results').textContent = `Error: ${error.message}`;
            } finally {
                resetButton(button, 'Get Selection');
            }
        });
        
        // Create Frame Tool - Toggle params form
        document.getElementById('create-frame').addEventListener('click', () => {
            const paramsForm = document.getElementById('frame-params');
            paramsForm.style.display = paramsForm.style.display === 'none' ? 'block' : 'none';
        });
        
        // Create Frame params form submission
        document.getElementById('frame-params-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const button = e.target.querySelector('button[type="submit"]');
            showLoading(button);
            
            const x = document.getElementById('frame-x').value;
            const y = document.getElementById('frame-y').value;
            const width = document.getElementById('frame-width').value;
            const height = document.getElementById('frame-height').value;
            const name = document.getElementById('frame-name').value;
            
            try {
                const response = await fetch(`/tool/create_root_frame?x=${x}&y=${y}&width=${width}&height=${height}&name=${encodeURIComponent(name)}`, {
                    method: 'POST',
                });
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                document.getElementById('tool-results').textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                document.getElementById('tool-results').textContent = `Error: ${error.message}`;
            } finally {
                resetButton(button, 'Create');
            }
        });
        
        // Create Text in Root Frame Tool
        document.getElementById('create-text').addEventListener('click', async (e) => {
            const button = e.target;
            showLoading(button);
            
            try {
                const response = await fetch('/tool/create_text_in_root_frame', {
                    method: 'POST',
                });
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                document.getElementById('tool-results').textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                document.getElementById('tool-results').textContent = `Error: ${error.message}`;
            } finally {
                resetButton(button, 'Create Text in Root Frame');
            }
        });
        
        // Log startup
        log("Chat interface initialized");
    </script>
</body>
</html>