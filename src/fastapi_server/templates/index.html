<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CXI MCP Server Interface</title>
    <style>
        /* Color variables */
        :root {
            --color-canvas-default: #fff;
            --color-canvas-subtle: #f6f8fa;
            --color-border-default: #d0d7de;
            --color-border-muted: #d8dee4;
            --color-accent-fg: #0969da;
            --color-accent-emphasis: #0969da;
            --color-fg-default: #24292f;
            --color-fg-muted: #57606a;
            --color-fg-subtle: #6e7781;
            --color-success-fg: #1a7f37;
            --color-danger-fg: #cf222e;
        }
        
        /* Base styles */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            color: var(--color-fg-default);
            line-height: 1.6;
        }
        
        /* Layout */
        .container {
            display: flex;
            height: 100vh;
            width: 100%;
        }
        
        .main-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--color-border-default);
            max-width: 65%;
        }
        
        .sidebar-panel {
            width: 35%;
            padding: 16px;
            overflow-y: auto;
            background-color: var(--color-canvas-subtle);
        }
        
        /* Header */
        header {
            border-bottom: 1px solid var(--color-border-muted);
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        h1 {
            font-size: 20px;
            font-weight: 500;
            margin: 0;
        }
        
        /* Task container */
        .task-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .task-header {
            background-color: var(--color-canvas-subtle);
            border-bottom: 1px solid var(--color-border-default);
            padding: 8px 16px;
        }
        
        .task-header h2 {
            font-size: 16px;
            font-weight: 500;
            margin: 0;
        }
        
        .task-result {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background-color: var(--color-canvas-default);
        }

        .select-with-refresh {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .select-with-refresh select {
            flex: 1;
        }
        
        .button.small {
            padding: 4px;
            min-width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        
        /* Task type selector */
        .task-type-selector {
            display: flex;
            background-color: var(--color-canvas-subtle);
            border-bottom: 1px solid var(--color-border-default);
            padding: 0;
        }
        
        .task-type-option {
            flex: 1;
            padding: 10px 16px;
            text-align: center;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 500;
        }
        
        .task-type-option.active {
            background-color: var(--color-canvas-default);
            border-bottom: 3px solid var(--color-accent-fg);
            color: var(--color-accent-fg);
        }
        
        /* Forms and inputs */
        .task-form {
            background-color: var(--color-canvas-subtle);
            padding: 16px;
            border-top: 1px solid var(--color-border-default);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .form-group {
            display: flex;
            gap: 8px;
        }
        
        .task-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--color-border-default);
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
            line-height: 20px;
        }
        
        /* File input styling */
        .file-input-container {
            position: relative;
            display: inline-block;
        }
        
        .file-input {
            position: absolute;
            top: 0;
            left: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-label {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 5px 12px;
            font-size: 14px;
            font-weight: 500;
            line-height: 20px;
            white-space: nowrap;
            cursor: pointer;
            border: 1px solid var(--color-border-default);
            border-radius: 6px;
            background-color: var(--color-canvas-default);
            color: var(--color-fg-default);
        }
        
        .file-label:hover {
            background-color: var(--color-canvas-subtle);
        }
        
        .file-name {
            margin-left: 8px;
            font-size: 12px;
            color: var(--color-fg-muted);
        }
        
        /* Buttons */
        .button {
            padding: 5px 16px;
            font-size: 14px;
            font-weight: 500;
            line-height: 20px;
            white-space: nowrap;
            cursor: pointer;
            border: 1px solid var(--color-border-default);
            border-radius: 6px;
            background-color: var(--color-canvas-default);
            color: var(--color-fg-default);
        }
        
        .button.primary {
            background-color: var(--color-accent-emphasis);
            border-color: var(--color-accent-emphasis);
            color: white;
        }
        
        .button:hover {
            background-color: var(--color-canvas-subtle);
        }
        
        .button.primary:hover {
            background-color: #0550ae;
        }
        
        /* Messages */
        .message {
            margin-bottom: 16px;
            padding: 16px;
            border-radius: 6px;
            border: 1px solid var(--color-border-default);
        }
        
        .user-message {
            background-color: var(--color-canvas-subtle);
        }
        
        .ai-message {
            background-color: var(--color-canvas-default);
            border-left: 4px solid var(--color-accent-emphasis);
        }
        
        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .message-author {
            font-weight: 600;
            margin-right: 8px;
        }
        
        .message-time {
            font-size: 12px;
            color: var(--color-fg-muted);
        }
        
        .message-content {
            margin-bottom: 8px;
        }
        
        .message-metadata {
            font-size: 12px;
            padding: 8px;
            margin-top: 8px;
            border-radius: 6px;
            background-color: var(--color-canvas-subtle);
            color: var(--color-fg-muted);
            font-family: SFMono-Regular, Consolas, Liberation Mono, Menlo, monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        
        /* Details and summary */
        details {
            margin-top: 8px;
        }
        
        summary {
            cursor: pointer;
            color: var(--color-fg-muted);
            font-size: 12px;
        }
        
        /* Image gallery */
        .image-gallery {
            margin-top: 16px;
            border-top: 1px solid var(--color-border-muted);
            padding-top: 16px;
        }
        
        .gallery-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }
        
        .gallery-image {
            width: calc(50% - 4px);
            border: 1px solid var(--color-border-default);
            border-radius: 6px;
            overflow: hidden;
        }
        
        .gallery-image img {
            width: 100%;
            height: auto;
            display: block;
        }
        
        /* Tool calls and responses */
        .tool-workflow-item {
            margin-bottom: 16px;
            border-left: 2px solid var(--color-border-muted);
            padding-left: 10px;
        }
        
        .tool-call, .tool-response {
            margin: 8px 0;
            padding: 8px 10px;
            border-radius: 6px;
        }
        
        .tool-call {
            background-color: rgba(9, 105, 218, 0.08);
        }
        
        .tool-response {
            background-color: rgba(26, 127, 55, 0.08);
            margin-left: 16px;
        }
        
        /* Debug tools */
        .debug-tools {
            padding: 16px;
            background-color: var(--color-canvas-subtle);
            border: 1px solid var(--color-border-default);
            border-radius: 6px;
            margin-bottom: 16px;
        }

        .debug-tool-panel {
            padding: 16px;
            background-color: var(--color-canvas-subtle);
            border: 1px solid var(--color-border-default);
            border-radius: 6px;
            margin-bottom: 16px;
        }
        
        .debug-tool-panel h3 {
            margin-top: 0;
            margin-bottom: 12px;
            font-size: 16px;
            font-weight: 500;
        }
        
        .debug-tool-panel h4 {
            margin-top: 12px;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
        }
        
        /* Channel selector styles */
        .channel-selector {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .channel-selector .form-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .channel-selector select {
            width: 100%;
            padding: 8px;
        }
        
        .channel-selector .button-group {
            display: flex;
            gap: 8px;
        }
        
        #current-channel-display {
            font-weight: 600;
            color: var(--color-accent-fg);
        }
        
        .tool-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .tool-result {
            font-family: SFMono-Regular, Consolas, Liberation Mono, Menlo, monospace;
            background-color: var(--color-canvas-default);
            padding: 12px;
            border: 1px solid var(--color-border-default);
            border-radius: 6px;
            white-space: pre-wrap;
            overflow-x: auto;
            font-size: 13px;
            line-height: 1.4;
            margin-bottom: 16px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        /* Frame parameters form */
        .frame-params-form {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 8px;
        }
        
        .frame-params-form .form-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .frame-params-form button {
            grid-column: span 2;
            margin-top: 8px;
        }
        
        /* Loading animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: var(--color-accent-fg);
            animation: spin 0.8s ease infinite;
            margin-right: 10px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-panel">
            <header>
                <h1>CXI MCP Server Interface</h1>
            </header>
            
            <div class="task-container">
                <div class="task-header">
                    <h2>Task</h2>
                </div>
                
                <div class="task-type-selector">
                    <div class="task-type-option active" data-task-type="text">Text Only</div>
                    <div class="task-type-option" data-task-type="image">Image Only</div>
                    <div class="task-type-option" data-task-type="text-image">Text + Image</div>
                </div>
                
                <!-- Text-only Task Form -->
                <form id="text-task-form" class="task-form">
                    <div class="form-group">
                        <input type="text" id="text-input" class="task-input" placeholder="Type your instruction..." required>
                        <button type="submit" id="text-submit" class="button primary">Generate</button>
                    </div>
                </form>
                
                <!-- Image-only Task Form -->
                <form id="image-task-form" class="task-form" style="display:none;">
                    <div class="file-input-container">
                        <label class="file-label">
                            <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16">
                                <path d="M2 1.75C2 .784 2.784 0 3.75 0h6.586c.464 0 .909.184 1.237.513l2.914 2.914c.329.328.513.773.513 1.237v9.586A1.75 1.75 0 0 1 13.25 16h-9.5A1.75 1.75 0 0 1 2 14.25Zm1.75-.25a.25.25 0 0 0-.25.25v12.5c0 .138.112.25.25.25h9.5a.25.25 0 0 0 .25-.25V6h-2.75A1.75 1.75 0 0 1 9 4.25V1.5Zm6.75.062V4.25c0 .138.112.25.25.25h2.688l-.011-.013-2.914-2.914-.013-.011Z"></path>
                            </svg>
                            Select Image
                            <input type="file" id="image-only-upload" class="file-input" accept="image/*" required>
                        </label>
                        <span id="image-only-file-name" class="file-name"></span>
                    </div>
                    <div class="form-group">
                        <button type="submit" id="image-submit" class="button primary">Generate</button>
                    </div>
                </form>
                
                <!-- Text+Image Task Form -->
                <form id="text-image-task-form" class="task-form" style="display:none;">
                    <div class="file-input-container">
                        <label class="file-label">
                            <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16">
                                <path d="M2 1.75C2 .784 2.784 0 3.75 0h6.586c.464 0 .909.184 1.237.513l2.914 2.914c.329.328.513.773.513 1.237v9.586A1.75 1.75 0 0 1 13.25 16h-9.5A1.75 1.75 0 0 1 2 14.25Zm1.75-.25a.25.25 0 0 0-.25.25v12.5c0 .138.112.25.25.25h9.5a.25.25 0 0 0 .25-.25V6h-2.75A1.75 1.75 0 0 1 9 4.25V1.5Zm6.75.062V4.25c0 .138.112.25.25.25h2.688l-.011-.013-2.914-2.914-.013-.011Z"></path>
                            </svg>
                            Select Image
                            <input type="file" id="text-image-upload" class="file-input" accept="image/*" required>
                        </label>
                        <span id="text-image-file-name" class="file-name"></span>
                    </div>
                    <div class="form-group">
                        <input type="text" id="text-image-input" class="task-input" placeholder="Type your instruction..." required>
                        <button type="submit" id="text-image-submit" class="button primary">Generate</button>
                    </div>
                </form>
                
                <div class="task-result" id="task-result"></div>
                
                <div class="image-gallery" id="image-gallery" style="display: none;">
                    <h3>Generated Images</h3>
                    <div class="gallery-container" id="gallery-container"></div>
                </div>
            </div>
        </div>
        
        <div class="sidebar-panel">
            <h2>Debug Tools</h2>
        
            <!-- Channel Selector Panel -->
            <div class="debug-tool-panel">
                <h3>Channel Selector</h3>
                <div class="channel-selector">
                    <div class="form-group channel-select-container">
                        <label for="channel-select">Current Channel: <span id="current-channel-display">None</span></label>
                        <div class="select-with-refresh">
                            <select id="channel-select" class="task-input">
                                <option value="">Loading channels...</option>
                            </select>
                            <button id="refresh-channels" class="button small" title="Refresh Channels">
                                ↻
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Node Manipulation Panel -->
            <div class="debug-tool-panel">
                <h3>Node Tools</h3>
                <div class="tool-buttons">
                    <button id="get-selection" class="button">Get Selection</button>
                    <button id="create-frame" class="button">Create Root Frame</button>
                    <button id="create-text" class="button">Create Text in Root Frame</button>
                </div>
                
                <div id="frame-params" style="display: none;">
                    <h4>Create Frame Parameters</h4>
                    <form id="frame-params-form" class="frame-params-form">
                        <div class="form-group">
                            <label for="frame-x">X:</label>
                            <input type="number" id="frame-x" value="0">
                        </div>
                        <div class="form-group">
                            <label for="frame-y">Y:</label>
                            <input type="number" id="frame-y" value="0">
                        </div>
                        <div class="form-group">
                            <label for="frame-width">Width:</label>
                            <input type="number" id="frame-width" value="320" required>
                        </div>
                        <div class="form-group">
                            <label for="frame-height">Height:</label>
                            <input type="number" id="frame-height" value="720" required>
                        </div>
                        <div class="form-group">
                            <label for="frame-name">Name:</label>
                            <input type="text" id="frame-name" value="Frame">
                        </div>
                        <button type="submit" class="button primary">Create</button>
                    </form>
                </div>
            </div>
            
            <!-- Results Panel -->
            <div class="debug-tool-panel">
                <h3>Tool Results</h3>
                <div id="tool-results" class="tool-result"></div>
            </div>
        </div>
    </div>

    <script>
        // Setup and configuration
        const debugMode = true;
        
        // Utility functions
        function log(message, data) {
            if (debugMode) console.log(`[DEBUG] ${message}`, data || '');
        }
        
        function formatDate(date) {
            return new Date(date).toLocaleTimeString();
        }
        
        function showLoading(button) {
            button.disabled = true;
            button.innerHTML = '<span class="loading"></span>Generating...';
        }
        
        function resetButton(button, text = 'Generate') {
            button.disabled = false;
            button.textContent = text;
        }
        
        // Message handling functions
        function extractAIContent(response) {
            log("Extracting content from:", response);
            
            try {
                // Handle different response formats
                if (response && response.json_response) {
                    // Newer format
                    const json = response.json_response;
                    
                    if (json.main_content) {
                        return {
                            content: json.main_content,
                            fullResponse: json,
                            images: json.images || [],
                            messages: json.messages || []
                        };
                    }
                    
                    if (json.messages && json.messages.length > 0) {
                        return processMessages(json);
                    }
                }
                
                // Handle direct response object
                if (response && response.response) {
                    const content = response.response;
                    
                    if (typeof content === 'string') {
                        try {
                            const parsed = JSON.parse(content);
                            if (parsed && parsed.messages) return processMessages(parsed);
                        } catch (e) {
                            // Not JSON, use as plain string
                            return {
                                content: content,
                                fullResponse: response,
                                images: [],
                                messages: []
                            };
                        }
                    }
                }
                
                // Handle messages directly
                if (response && response.messages && Array.isArray(response.messages)) {
                    return processMessages(response);
                }
                
                // Fallback
                return {
                    content: typeof response === 'string' ? response : JSON.stringify(response),
                    fullResponse: response || {},
                    images: [],
                    messages: []
                };
                
            } catch (e) {
                console.error("Error extracting AI content:", e);
                return {
                    content: `Error processing response: ${e.message}`,
                    fullResponse: response || {},
                    images: [],
                    messages: []
                };
            }
            
            // Helper for processing message arrays
            function processMessages(container) {
                const messages = container.messages || [];
                
                // Find last assistant message with content
                for (let i = messages.length - 1; i >= 0; i--) {
                    const msg = messages[i];
                    
                    if (msg.role === 'assistant' && msg.content?.data?.content) {
                        return {
                            content: msg.content.data.content,
                            fullResponse: container,
                            images: container.images || [],
                            messages: messages
                        };
                    }
                    
                    if ((msg.type === 'ai' || msg.id?.startsWith('run-')) && msg.content) {
                        return {
                            content: msg.content,
                            fullResponse: container,
                            images: container.images || [],
                            messages: messages
                        };
                    }
                }
                
                return {
                    content: "",
                    fullResponse: container,
                    images: container.images || [],
                    messages: messages
                };
            }
        }
        
        function formatResponseMessage(response) {
            if (!response) return '<div class="error-message">Empty response received</div>';
            
            try {
                // Process json_response format
                if (response.json_response) {
                    const messages = response.json_response.messages || [];
                    let finalMessage = "";
                    let toolCalls = [];
                    let toolResponses = [];
                    
                    // Extract tool calls and final message
                    messages.forEach(msg => {
                        if (msg.role === 'assistant') {
                            // Get content
                            const content = msg.content?.data?.content || '';
                            if (content && content.trim() !== '') finalMessage = content;
                            
                            // Get tool calls
                            if (msg.content?.data?.tool_calls?.length > 0) {
                                msg.content.data.tool_calls.forEach(tool => {
                                    toolCalls.push({
                                        id: tool.id,
                                        name: tool.name,
                                        args: tool.args
                                    });
                                });
                            }
                        }
                        
                        if (msg.role === 'tool') {
                            const toolContent = msg.content?.data?.content || '';
                            const toolName = msg.content?.data?.name || '';
                            const toolCallId = msg.content?.data?.tool_call_id || '';
                            
                            if (toolContent && toolName) {
                                toolResponses.push({
                                    id: toolCallId,
                                    name: toolName,
                                    content: toolContent
                                });
                            }
                        }
                    });
                    
                    // Build workflow visualization
                    let conversationFlow = "";
                    if (toolCalls.length > 0) {
                        conversationFlow = '<div class="conversation-workflow"><h3>Actions Performed</h3>';
                        
                        toolCalls.forEach(tool => {
                            conversationFlow += `
                                <div class="tool-workflow-item">
                                    <div class="tool-call">
                                        <div class="tool-call-label">
                                            <span class="tool-icon">⚙️</span>
                                            <strong>${tool.name}</strong>
                                        </div>
                                        <div class="tool-call-content">
                                            <pre>${JSON.stringify(tool.args, null, 2)}</pre>
                                        </div>
                                    </div>`;
                            
                            // Find matching response
                            const response = toolResponses.find(r => r.id === tool.id);
                            if (response) {
                                conversationFlow += `
                                    <div class="tool-response">
                                        <div class="tool-response-label">
                                            <span class="tool-icon">✓</span>
                                            <strong>${response.name} Result:</strong>
                                        </div>
                                        <div class="tool-response-content">${response.content}</div>
                                    </div>`;
                            }
                            
                            conversationFlow += '</div>';
                        });
                        
                        conversationFlow += '</div>';
                    }
                    
                    // Return formatted message
                    return `
                        ${finalMessage ? `<div class="message-content">${finalMessage}</div>` : ''}
                        ${conversationFlow}
                        <details>
                            <summary>Show details</summary>
                            <div class="message-metadata">${JSON.stringify(response, null, 2)}</div>
                        </details>`;
                }
                
                // Fallback for other formats
                const { content, fullResponse } = extractAIContent(response);
                return `
                    <div class="message-content">${content || "No message content"}</div>
                    <details>
                        <summary>Show details</summary>
                        <div class="message-metadata">${JSON.stringify(fullResponse, null, 2)}</div>
                    </details>`;
                
            } catch (e) {
                console.error("Error formatting message:", e);
                return `
                    <div class="error-message">Error formatting response: ${e.message}</div>
                    <details>
                        <summary>Show raw response</summary>
                        <div class="message-metadata">${JSON.stringify(response, null, 2)}</div>
                    </details>`;
            }
        }
        
        function addImageToGallery(imageData) {
            if (!imageData) return;
            
            const galleryContainer = document.getElementById('gallery-container');
            const imageGallery = document.getElementById('image-gallery');
            
            imageGallery.style.display = 'block';
            
            const imageWrapper = document.createElement('div');
            imageWrapper.className = 'gallery-image';
            
            const img = document.createElement('img');
            img.src = `data:image/png;base64,${imageData}`;
            img.alt = 'Generated image';
            
            imageWrapper.appendChild(img);
            galleryContainer.appendChild(imageWrapper);
        }
        
        function displayTaskResult(response) {
            log("Displaying task result", response);
            
            const resultContainer = document.getElementById('task-result');
            const messageElement = document.createElement('div');
            messageElement.className = 'message ai-message';
            
            const now = new Date();
            const messageHTML = `
                <div class="message-header">
                    <span class="message-author">System</span>
                    <span class="message-time">${formatDate(now)}</span>
                </div>
                <div class="message-content-container">
                    ${formatResponseMessage(response)}
                </div>`;
            
            messageElement.innerHTML = messageHTML;
            
            // Clear previous results
            resultContainer.innerHTML = '';
            resultContainer.appendChild(messageElement);
            resultContainer.scrollTop = 0;
            
            // Process images in AI responses
            const { images } = extractAIContent(response);
            if (images && images.length > 0) {
                images.forEach(img => {
                    if (img && img.data && !img.data.startsWith('base64_uris')) {
                        addImageToGallery(img.data);
                    }
                });
            }
        }
        
        async function fetchChannels() {
            try {
                const button = document.getElementById('refresh-channels');
                showLoading(button);
                
                const response = await fetch('/tool/get_channels', { method: 'POST' });
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                log("Channel list:", data);
                
                // Update channel dropdown
                const channelSelect = document.getElementById('channel-select');
                channelSelect.innerHTML = ''; // Clear options
                
                // Add a placeholder option
                const placeholderOption = document.createElement('option');
                placeholderOption.value = '';
                placeholderOption.textContent = '-- Select a channel --';
                channelSelect.appendChild(placeholderOption);
                
                // Add channel options
                if (data.status === 'success' && data.available_channels) {
                    data.available_channels.forEach(channel => {
                        const option = document.createElement('option');
                        option.value = channel;
                        option.textContent = channel;
                        channelSelect.appendChild(option);
                    });
                    
                    // Update current channel display
                    if (data.current_channel && data.current_channel !== 'None') {
                        document.getElementById('current-channel-display').textContent = data.current_channel;
                        // Select the current channel in dropdown
                        Array.from(channelSelect.options).forEach(option => {
                            if (option.value === data.current_channel) {
                                option.selected = true;
                            }
                        });
                    }
                } else {
                    document.getElementById('tool-results').textContent = `Error fetching channels: ${data.message || 'Unknown error'}`;
                }
                
                resetButton(button, '↻');
            } catch (error) {
                document.getElementById('tool-results').textContent = `Error: ${error.message}`;
                resetButton(document.getElementById('refresh-channels'), '↻');
            }
        }
        
        async function joinSelectedChannel(channelName) {
            if (!channelName) {
                return;
            }
            
            try {
                // Show loading state in the display text
                document.getElementById('current-channel-display').textContent = `Joining ${channelName}...`;
                
                const response = await fetch(`/tool/select_channel?channel=${encodeURIComponent(channelName)}`, {
                    method: 'POST',
                });
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                log("Join channel response:", data);
                
                if (data.status === 'success') {
                    document.getElementById('current-channel-display').textContent = data.channel || channelName;
                    document.getElementById('tool-results').textContent = `Successfully joined channel: ${data.channel || channelName}`;
                } else {
                    document.getElementById('current-channel-display').textContent = 'Connection failed';
                    document.getElementById('tool-results').textContent = `Error joining channel: ${data.message || 'Unknown error'}`;
                }
            } catch (error) {
                document.getElementById('current-channel-display').textContent = 'Connection error';
                document.getElementById('tool-results').textContent = `Error: ${error.message}`;
            }
        }
        
        // Event listeners for channel selector
        // Refresh channels button
        document.getElementById('refresh-channels').addEventListener('click', fetchChannels);
        
        // Channel select change event - automatically join the selected channel
        document.getElementById('channel-select').addEventListener('change', function() {
            const selectedChannel = this.value;
            if (selectedChannel) {
                joinSelectedChannel(selectedChannel);
            }
        });
        // Initialize - fetch channels when page loads
        document.addEventListener('DOMContentLoaded', fetchChannels);
        
        // Task type selector
        document.querySelectorAll('.task-type-option').forEach(option => {
            option.addEventListener('click', function() {
                // Reset active state
                document.querySelectorAll('.task-type-option').forEach(opt => {
                    opt.classList.remove('active');
                });
                
                // Set this option as active
                this.classList.add('active');
                
                // Hide all forms
                document.querySelectorAll('.task-form').forEach(form => {
                    form.style.display = 'none';
                });
                
                // Show the selected form
                const taskType = this.getAttribute('data-task-type');
                document.getElementById(`${taskType}-task-form`).style.display = 'flex';
            });
        });
        
        // File input event handlers
        document.getElementById('image-only-upload').addEventListener('change', function(e) {
            const fileName = e.target.files.length > 0 ? e.target.files[0].name : '';
            document.getElementById('image-only-file-name').textContent = fileName;
        });
        
        document.getElementById('text-image-upload').addEventListener('change', function(e) {
            const fileName = e.target.files.length > 0 ? e.target.files[0].name : '';
            document.getElementById('text-image-file-name').textContent = fileName;
        });
        
        // Task form handlers
        document.getElementById('text-task-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = document.getElementById('text-input').value;
            
            if (!message) return;
            
            const submitButton = document.getElementById('text-submit');
            showLoading(submitButton);
            
            try {
                // Send text-only task
                log("Submitting text-only task", { message });
                const response = await fetch('/generate/text', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message }),
                });
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                log("Server response:", data);
                displayTaskResult(data);
            } catch (error) {
                console.error("Request error:", error);
                displayTaskResult({ response: `Error: ${error.message}` });
            } finally {
                resetButton(submitButton);
            }
        });
        
        document.getElementById('image-task-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const imageFile = document.getElementById('image-only-upload').files[0];
            
            if (!imageFile) return;
            
            const submitButton = document.getElementById('image-submit');
            showLoading(submitButton);
            
            try {
                // Send image-only task
                log("Submitting image-only task", { image: imageFile.name });
                const formData = new FormData();
                formData.append('image', imageFile);
                
                const response = await fetch('/generate/image', {
                    method: 'POST',
                    body: formData,
                });
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                log("Server response:", data);
                displayTaskResult(data);
            } catch (error) {
                console.error("Request error:", error);
                displayTaskResult({ response: `Error: ${error.message}` });
            } finally {
                resetButton(submitButton);
            }
        });
        
        document.getElementById('text-image-task-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = document.getElementById('text-image-input').value;
            const imageFile = document.getElementById('text-image-upload').files[0];
            
            if (!message || !imageFile) return;
            
            const submitButton = document.getElementById('text-image-submit');
            showLoading(submitButton);
            
            try {
                // Send text+image task
                log("Submitting text+image task", { message, image: imageFile.name });
                const formData = new FormData();
                formData.append('message', message);
                formData.append('image', imageFile);
                
                const response = await fetch('/generate/text-image', {
                    method: 'POST',
                    body: formData,
                });
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                log("Server response:", data);
                displayTaskResult(data);
            } catch (error) {
                console.error("Request error:", error);
                displayTaskResult({ response: `Error: ${error.message}` });
            } finally {
                resetButton(submitButton);
            }
        });
        
        // Debug tools handlers
        document.getElementById('get-selection').addEventListener('click', async (e) => {
            const button = e.target;
            showLoading(button);
            
            try {
                const response = await fetch('/tool/get_selection', { method: 'POST' });
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                document.getElementById('tool-results').textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                document.getElementById('tool-results').textContent = `Error: ${error.message}`;
            } finally {
                resetButton(button, 'Get Selection');
            }
        });
        
        document.getElementById('create-frame').addEventListener('click', () => {
            const paramsForm = document.getElementById('frame-params');
            paramsForm.style.display = paramsForm.style.display === 'none' ? 'block' : 'none';
        });
        
        document.getElementById('frame-params-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const button = e.target.querySelector('button[type="submit"]');
            showLoading(button);
            
            const x = document.getElementById('frame-x').value;
            const y = document.getElementById('frame-y').value;
            const width = document.getElementById('frame-width').value;
            const height = document.getElementById('frame-height').value;
            const name = document.getElementById('frame-name').value;
            
            try {
                const response = await fetch(`/tool/create_root_frame?x=${x}&y=${y}&width=${width}&height=${height}&name=${encodeURIComponent(name)}`, {
                    method: 'POST',
                });
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                document.getElementById('tool-results').textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                document.getElementById('tool-results').textContent = `Error: ${error.message}`;
            } finally {
                resetButton(button, 'Create');
            }
        });
        
        document.getElementById('create-text').addEventListener('click', async (e) => {
            const button = e.target;
            showLoading(button);
            
            try {
                const response = await fetch('/tool/create_text_in_root_frame', { method: 'POST' });
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                document.getElementById('tool-results').textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                document.getElementById('tool-results').textContent = `Error: ${error.message}`;
            } finally {
                resetButton(button, 'Create Text in Root Frame');
            }
        });
        
        // Initialize
        log("Task interface initialized");
    </script>
</body>
</html>